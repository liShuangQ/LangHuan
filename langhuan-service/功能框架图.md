# 功能框架图

## 系统整体架构

```mermaid
graph TB
    subgraph "前端/客户端"
        A[用户界面]
    end
    
    subgraph "API网关层"
        B[Spring Security]
        C[JWT认证]
    end
    
    subgraph "控制器层"
        D[ChatController]
        E[RagController]
        F[RagFileController]
    end
    
    subgraph "业务服务层"
        G[ChatService]
        H[RagService]
        I[ChatGeneralAssistanceService]
        J[ReRankModelService]
    end
    
    subgraph "AI服务层"
        K[Spring AI ChatClient]
        L[OpenAI API]
        M[Ollama本地模型]
    end
    
    subgraph "数据存储层"
        N[PostgreSQL]
        O[pgvector向量数据库]
        P[JDBC Chat Memory]
    end
    
    subgraph "文件处理"
        Q[Tika文档读取器]
        R[文本分割器]
        S[向量化处理]
    end
    
    A --> B
    B --> C
    C --> D
    C --> E
    C --> F
    D --> G
    E --> H
    F --> H
    G --> K
    G --> I
    H --> J
    K --> L
    K --> M
    G --> P
    H --> O
    H --> Q
    Q --> R
    R --> S
    S --> O
```

## AI对话处理流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as ChatController
    participant CS as ChatService
    participant AI as Spring AI
    participant MM as 聊天记忆
    participant DB as 数据库
    
    U->>C: POST /chat/chat
    Note over C: 参数: id, p, q, isRag, isReRank, groupId, isFunction, modelName
    
    C->>CS: chat(chatRestOption)
    
    alt 启用RAG检索
        CS->>CS: isRagChat()
        CS->>CS: ragSearch(q, groupId, isReRank)
        CS->>AI: 构建RAG提示词
        Note over CS: 将检索到的文档内容<br/>注入到AI提示词中
    else 普通对话
        CS->>CS: noRagChat()
        CS->>AI: 直接对话
    end
    
    AI->>AI: 处理用户问题
    AI->>MM: 保存对话历史
    AI->>CS: 返回AI响应
    
    alt 工具调用
        CS->>CS: 检查是否包含工具调用
        Note over CS: 如果响应包含"***tools***"<br/>则进行二次处理
    end
    
    CS->>C: 返回ChatModelResult
    C->>U: 返回聊天结果和RAG文档
```

## RAG检索增强生成流程

```mermaid
flowchart TD
    A[用户上传文档] --> B[TikaDocumentReader]
    B --> C[文档内容提取]
    C --> D{选择分割方法}
    
    D -->|固定窗口| E[FixedWindowTextSplitter]
    D -->|模式分割| F[PatternTokenTextSplitter]
    D -->|LLM分割| G[LlmTextSplitter]
    
    E --> H[文档块分割]
    F --> H
    G --> H
    
    H --> I[向量化处理]
    I --> J[存储到pgvector]
    
    K[用户提问] --> L[RagService.ragSearch]
    L --> M[向量相似度搜索]
    M --> N[获取相关文档]
    
    N --> O{排序算法类型}
    O -->|数值过滤| P[rank_numFilter]
    O -->|线性加权| Q[rank_linearWeighting]
    
    P --> R{是否启用重排序}
    Q --> S{是否启用重排序}
    
    R -->|是| T[ReRankModelService重排序]
    R -->|否| U[仅手工排名排序]
    S -->|是| V[ReRankModelService重排序]
    S -->|否| W[手工排名归一化]
    
    T --> X[手工排名排序]
    U --> X
    V --> Y[线性加权重排序]
    W --> Y
    
    X --> Z[排序后的文档]
    Y --> Z
    
    Z --> AA[构建RAG提示词]
    AA --> BB[发送给AI模型]
    BB --> CC[生成增强回答]
```

## 文档处理详细流程

```mermaid
graph LR
    subgraph "文档上传"
        A[MultipartFile] --> B[TikaDocumentReader]
        B --> C[提取文本内容]
    end
    
    subgraph "文本分割"
        C --> D[文本预处理]
        D --> E{分割策略}
        E -->|固定窗口| F[FixedWindowTextSplitter]
        E -->|模式匹配| G[PatternTokenTextSplitter]
        E -->|LLM智能分割| H[LlmTextSplitter]
    end
    
    subgraph "向量化存储"
        F --> I[文档块]
        G --> I
        H --> I
        I --> J[RagMetaData元数据]
        J --> K[Document对象]
        K --> L[VectorStore.add]
        L --> M[pgvector存储]
    end
    
    subgraph "检索流程"
        N[用户查询] --> O[向量化查询]
        O --> P[相似度搜索]
        P --> Q[获取Top-K文档]
        Q --> R[重排序处理]
        R --> S[返回相关文档]
    end
```

## 聊天记忆管理

```mermaid
graph TD
    A[用户开始对话] --> B[生成会话ID]
    B --> C[初始化ChatMemory]
    C --> D[MessageWindowChatMemory]
    
    D --> E[保存到JDBC]
    E --> F[PostgreSQL存储]
    
    G[用户发送消息] --> H[添加到内存]
    H --> I[更新对话历史]
    I --> J[保存到数据库]
    
    K[用户切换会话] --> L[加载历史对话]
    L --> M[从数据库读取]
    M --> N[恢复到内存]
    
    O[用户保存会话] --> P[setChatMemoryWindowsName]
    P --> Q[更新会话名称]
    
    R[用户清除会话] --> S[clearChatMemory]
    S --> T[清空内存和数据库]
```

## 系统配置架构

```mermaid
graph TB
    subgraph "配置层"
        A[AiConfig] --> B[AI模型配置]
        C[VectorStoreConfig] --> D[向量存储配置]
        E[SecurityConfig] --> F[安全配置]
        G[MybatisPlusConfig] --> H[数据库配置]
    end
    
    subgraph "工具层"
        I[RagFileVectorUtils] --> J[文档处理工具]
        K[JwtUtil] --> L[JWT工具]
        M[DateTimeUtils] --> N[时间工具]
        O[RestRequestTools] --> P[HTTP请求工具]
    end
    
    subgraph "切面层"
        Q[ApiLogAspect] --> R[API日志记录]
        S[WebLogInterceptor] --> T[Web请求拦截]
    end
    
    subgraph "异常处理"
        U[GlobalExceptionHandler] --> V[全局异常处理]
        W[BusinessException] --> X[业务异常]
    end
```

## 核心功能模块关系

```mermaid
graph LR
    subgraph "用户交互"
        A[ChatController] --> B[聊天接口]
        C[RagController] --> D[RAG检索接口]
        E[RagFileController] --> F[文件管理接口]
    end
    
    subgraph "业务逻辑"
        B --> G[ChatService]
        D --> H[RagService]
        F --> H
        G --> I[ChatGeneralAssistanceService]
        H --> J[ReRankModelService]
    end
    
    subgraph "AI处理"
        G --> K[Spring AI ChatClient]
        I --> K
        K --> L[OpenAI/Ollama]
    end
    
    subgraph "数据存储"
        G --> M[JDBC Chat Memory]
        H --> N[pgvector向量库]
        H --> O[PostgreSQL]
    end
    
    subgraph "文档处理"
        H --> P[RagFileVectorUtils]
        P --> Q[文本分割器]
        P --> R[Tika文档读取]
    end
```

## 技术栈架构

```mermaid
graph TB
    subgraph "应用框架"
        A[Spring Boot 3.4.1] --> B[Spring Security]
        A --> C[Spring AI 1.0.0]
        A --> D[MyBatis-Plus 3.5.7]
    end
    
    subgraph "数据库"
        E[PostgreSQL] --> F[pgvector扩展]
        G[JDBC] --> H[聊天记忆存储]
    end
    
    subgraph "AI模型"
        I[OpenAI API] --> J[GPT系列模型]
        K[Ollama] --> L[本地模型]
        M[One API] --> N[模型管理]
    end
    
    subgraph "工具库"
        O[Hutool 5.8.34] --> P[工具类]
        Q[Lombok 1.18.36] --> R[代码简化]
        S[JWT] --> T[认证授权]
    end
    
    subgraph "文档处理"
        U[Apache Tika] --> V[文档解析]
        W[文本分割器] --> X[文档分块]
        Y[向量化] --> Z[语义存储]
    end
```

## 关键特性说明

### 1. AI对话特性
- **多模型支持**: 支持OpenAI API和Ollama本地模型
- **聊天记忆**: 基于JDBC的持久化聊天历史
- **工具调用**: 支持AI工具调用和二次处理
- **会话管理**: 支持多会话切换和命名

### 2. RAG检索特性
- **文档处理**: 支持多种格式文档上传和解析
- **智能分割**: 多种文本分割策略（固定窗口、模式匹配、LLM分割）
- **向量存储**: 基于pgvector的高效向量检索
- **重排序**: 支持线性加权和数值过滤重排序
- **元数据管理**: 完整的文档元数据跟踪

### 3. 系统特性
- **安全认证**: JWT基于Spring Security的认证授权
- **API日志**: 完整的API调用日志记录
- **异常处理**: 全局异常处理和业务异常管理
- **配置管理**: 灵活的配置管理和环境适配 