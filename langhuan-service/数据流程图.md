# 数据流程图

## 系统数据流概览

```mermaid
graph TB
    subgraph "用户输入数据"
        A[用户问题文本]
        B[文档文件]
        C[会话ID]
        D[模型配置]
    end
    
    subgraph "处理层"
        E[ChatController]
        F[RagService]
        G[ChatService]
        H[AI模型]
    end
    
    subgraph "数据存储"
        I[PostgreSQL]
        J[pgvector向量库]
        K[JDBC聊天记忆]
    end
    
    subgraph "输出数据"
        L[AI回答]
        M[相关文档]
        N[会话历史]
    end
    
    A --> E
    B --> F
    C --> G
    D --> H
    E --> G
    F --> J
    G --> H
    G --> K
    H --> L
    F --> M
    G --> N
```

## AI对话数据流

```mermaid
flowchart TD
    subgraph "输入数据"
        A[用户问题: String]
        B[会话ID: String]
        C[提示词: String]
        D[模型名称: String]
        E[是否RAG: Boolean]
        F[是否重排序: Boolean]
        G[文件组ID: String]
        H[是否工具调用: Boolean]
    end
    
    subgraph "ChatRestOption对象"
        I[chatId: String]
        J[prompt: String]
        K[question: String]
        L[isRag: Boolean]
        M[ragGroupId: String]
        N[isReRank: Boolean]
        O[isFunction: Boolean]
        P[modelName: String]
    end
    
    subgraph "处理流程"
        Q[ChatService.chat]
        R{是否启用RAG}
        S[RagService.ragSearch]
        T[向量相似度搜索]
        U[获取相关文档]
        V[构建RAG提示词]
        W[AI模型处理]
        X[生成回答]
    end
    
    subgraph "输出数据"
        Y[ChatModelResult]
        Z[chat: String]
        AA[rag: List<Document>]
    end
    
    A --> I
    B --> I
    C --> J
    D --> P
    E --> L
    F --> N
    G --> M
    H --> O
    
    I --> Q
    J --> Q
    K --> Q
    L --> Q
    M --> Q
    N --> Q
    O --> Q
    P --> Q
    
    Q --> R
    R -->|是| S
    R -->|否| W
    S --> T
    T --> U
    U --> V
    V --> W
    W --> X
    X --> Y
    Y --> Z
    Y --> AA
```

## RAG文档处理数据流

```mermaid
flowchart TD
    subgraph "文档上传"
        A[MultipartFile]
        B[文件名: String]
        C[文件类型: String]
        D[文件大小: String]
        E[文件描述: String]
        F[文件组ID: String]
        G[上传用户: String]
    end
    
    subgraph "TRagFile实体"
        H[id: Integer]
        I[fileName: String]
        J[fileType: String]
        K[fileSize: String]
        L[documentNum: String]
        M[fileDesc: String]
        N[fileGroupId: String]
        O[uploadedBy: String]
        P[uploadedAt: Date]
    end
    
    subgraph "文档处理"
        Q[TikaDocumentReader]
        R[文本内容提取]
        S[文本分割]
        T[文档块列表]
        U[向量化处理]
        V[元数据生成]
    end
    
    subgraph "向量存储"
        W[VectorStoreRag]
        X[id: UUID]
        Y[content: String]
        Z[metadata: JSON]
        AA[embedding: Vector]
    end
    
    subgraph "pgvector数据库"
        BB[vector_store_rag表]
        CC[文档内容]
        DD[元数据JSON]
        EE[向量嵌入]
    end
    
    A --> Q
    B --> I
    C --> J
    D --> K
    E --> M
    F --> N
    G --> O
    
    Q --> R
    R --> S
    S --> T
    T --> U
    U --> V
    
    H --> W
    I --> W
    J --> W
    K --> W
    L --> W
    M --> W
    N --> W
    O --> W
    P --> W
    
    V --> Z
    U --> AA
    T --> Y
    
    W --> BB
    Y --> CC
    Z --> DD
    AA --> EE
```

## 聊天记忆数据流

```mermaid
flowchart TD
    subgraph "用户会话"
        A[用户ID: String]
        B[会话ID: String]
        C[会话名称: String]
        D[创建时间: Date]
    end
    
    subgraph "TUserChatWindow实体"
        E[id: Integer]
        F[userId: String]
        G[conversationId: String]
        H[conversationName: String]
        I[createdTime: Date]
    end
    
    subgraph "消息数据"
        J[Message对象]
        K[role: String]
        L[content: String]
        M[timestamp: Date]
    end
    
    subgraph "聊天记忆存储"
        N[MessageWindowChatMemory]
        O[JdbcChatMemoryRepository]
        P[PostgreSQL数据库]
    end
    
    subgraph "内存管理"
        Q[内存中的对话历史]
        R[数据库持久化]
        S[会话切换]
    end
    
    A --> F
    B --> G
    C --> H
    D --> I
    
    E --> N
    F --> N
    G --> N
    H --> N
    I --> N
    
    J --> O
    K --> J
    L --> J
    M --> J
    
    N --> O
    O --> P
    N --> Q
    O --> R
    Q --> S
    R --> S
```

## 向量检索数据流

```mermaid
flowchart TD
    subgraph "查询输入"
        A[用户问题: String]
        B[文件组ID: String]
        C[文件ID: String]
        D[是否重排序: Boolean]
    end
    
    subgraph "向量化查询"
        E[问题文本向量化]
        F[生成查询向量]
        G[相似度计算]
    end
    
    subgraph "检索过程"
        H[VectorStore.search]
        I[Top-K文档检索]
        J[相似度排序]
        K[文档过滤]
    end
    
    subgraph "重排序处理"
        L{是否启用重排序}
        M[ReRankModelService]
        N[线性加权重排序]
        O[数值过滤重排序]
    end
    
    subgraph "输出文档"
        P[List<Document>]
        Q[content: String]
        R[metadata: Map]
        S[相似度分数]
    end
    
    A --> E
    B --> H
    C --> H
    D --> L
    
    E --> F
    F --> G
    G --> H
    
    H --> I
    I --> J
    J --> K
    
    L -->|是| M
    L -->|否| P
    M --> N
    M --> O
    N --> P
    O --> P
    
    P --> Q
    P --> R
    P --> S
```

## 文档分割数据流

```mermaid
flowchart TD
    subgraph "原始文档"
        A[文档文件]
        B[文档内容: String]
        C[文档格式: String]
    end
    
    subgraph "分割策略"
        D[FixedWindowTextSplitter]
        E[PatternTokenTextSplitter]
        F[LlmTextSplitter]
        G[SlidingWindowTextSplitter]
    end
    
    subgraph "分割参数"
        H[windowSize: Integer]
        I[splitPattern: String]
        J[modelName: String]
        K[overlapSize: Integer]
    end
    
    subgraph "分割结果"
        L[文档块列表]
        M[块内容: String]
        N[块大小: Integer]
        O[块索引: Integer]
    end
    
    subgraph "元数据生成"
        P[RagMetaData]
        Q[filename: String]
        R[fileId: String]
        S[groupId: String]
        T[rank: Integer]
    end
    
    A --> B
    B --> D
    B --> E
    B --> F
    B --> G
    
    H --> D
    I --> E
    J --> F
    K --> G
    
    D --> L
    E --> L
    F --> L
    G --> L
    
    L --> M
    L --> N
    L --> O
    
    M --> P
    Q --> P
    R --> P
    S --> P
    T --> P
```

## 数据实体关系图

```mermaid
erDiagram
    TUserChatWindow {
        int id PK
        string userId
        string conversationId
        string conversationName
        date createdTime
    }
    
    TRagFile {
        int id PK
        string fileName
        string fileType
        string fileSize
        string documentNum
        string fileDesc
        string fileGroupId
        string uploadedBy
        date uploadedAt
    }
    
    VectorStoreRag {
        uuid id PK
        string content
        json metadata
        vector embedding
    }
    
    ChatModelResult {
        string chat
        list rag
    }
    
    ChatRestOption {
        string chatId
        string prompt
        string question
        boolean isRag
        string ragGroupId
        boolean isReRank
        boolean isFunction
        string modelName
    }
    
    TUserChatWindow ||--o{ VectorStoreRag : "用户上传文档"
    TRagFile ||--o{ VectorStoreRag : "文件向量化"
    ChatRestOption ||--|| ChatModelResult : "生成回答"
    VectorStoreRag ||--o{ ChatModelResult : "RAG检索"
```

## 数据转换流程

```mermaid
flowchart LR
    subgraph "输入数据转换"
        A[用户输入] --> B[ChatRestOption]
        C[文件上传] --> D[TRagFile]
        E[文档内容] --> F[Document对象]
    end
    
    subgraph "处理数据转换"
        B --> G[ChatService处理]
        D --> H[RagService处理]
        F --> I[向量化处理]
    end
    
    subgraph "存储数据转换"
        G --> J[ChatModelResult]
        H --> K[VectorStoreRag]
        I --> L[pgvector存储]
    end
    
    subgraph "输出数据转换"
        J --> M[JSON响应]
        K --> N[检索结果]
        L --> O[向量查询]
    end
    
    A --> B
    C --> D
    E --> F
    
    B --> G
    D --> H
    F --> I
    
    G --> J
    H --> K
    I --> L
    
    J --> M
    K --> N
    L --> O
```

## 关键数据流说明

### 1. AI对话数据流
- **输入数据**: 用户问题、会话ID、模型配置等
- **处理流程**: ChatRestOption → ChatService → AI模型
- **输出数据**: ChatModelResult包含AI回答和相关文档

### 2. RAG文档处理数据流
- **文档上传**: MultipartFile → TRagFile实体
- **文档处理**: Tika读取 → 文本分割 → 向量化
- **向量存储**: Document → VectorStoreRag → pgvector

### 3. 聊天记忆数据流
- **会话管理**: TUserChatWindow存储会话信息
- **消息存储**: Message对象 → JDBC → PostgreSQL
- **记忆管理**: 内存缓存 + 数据库持久化

### 4. 向量检索数据流
- **查询处理**: 问题向量化 → 相似度搜索 → 重排序
- **结果输出**: List<Document>包含内容和元数据

### 5. 数据实体关系
- **用户会话**: TUserChatWindow管理用户对话
- **文件管理**: TRagFile管理上传的文档
- **向量存储**: VectorStoreRag存储文档向量
- **对话结果**: ChatModelResult封装AI回答

### 6. 数据转换特点
- **类型安全**: 使用强类型实体类
- **JSON序列化**: 元数据使用JSON格式
- **向量存储**: 使用pgvector扩展存储向量
- **分页查询**: 支持大数据量的分页处理 