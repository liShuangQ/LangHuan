# 代码目录说明

## 项目概述

**LangHuan Service** 是一个基于 Spring Boot 3.x 的智能对话服务系统，集成了 AI 模型、RAG（检索增强生成）技术、用户权限管理等功能。项目采用 Java 21 开发，使用 PostgreSQL 作为主数据库，支持向量数据库进行文档检索。

### 技术栈
- **框架**: Spring Boot 3.4.1-SNAPSHOT
- **Java版本**: Java 21
- **数据库**: PostgreSQL + pgvector（向量数据库）
- **AI框架**: Spring AI 1.0.0
- **ORM**: MyBatis-Plus 3.5.7
- **安全**: Spring Security + JWT
- **工具库**: Hutool 5.8.34, Lombok 1.18.36

## 目录结构说明

```
langhuan-service/
├── src/main/java/com/langhuan/
│   ├── Aiagent7Application.java          # 应用程序启动类
│   ├── advisors/                         # AOP 切面类
│   ├── common/                           # 公共组件
│   ├── config/                           # 配置类
│   ├── controller/                       # 控制器层
│   ├── filter/                           # 安全过滤器
│   ├── functionTools/                    # 功能工具类
│   ├── model/                            # 数据模型层
│   ├── service/                          # 业务服务层
│   ├── serviceai/                        # AI 服务层
│   └── utils/                            # 工具类
└── src/main/resources/
    ├── application.yml                   # 应用配置文件
    ├── mapper/                           # MyBatis XML映射文件
    ├── prompts/                          # 提示词模板
    ├── sql/                              # 数据库脚本
    └── static/                           # 静态资源
```

## 详细模块说明

### 1. 启动类 (Aiagent7Application.java)
- **功能**: Spring Boot 应用程序入口
- **位置**: `src/main/java/com/langhuan/Aiagent7Application.java`

### 2. 切面类 (advisors/)
- **功能**: AOP 切面编程，用于日志记录、性能监控等
- **主要文件**:
  - `MyQuestionAnswerAdvisor.java` - 问答切面
  - `MySimplelogAdvisor.java.bak` - 日志切面（备份）
  - `ReReadingAdvisor.java.bak` - 重读切面（备份）

### 3. 公共组件 (common/)
- **功能**: 项目公共组件，包含异常处理、响应封装等
- **主要文件**:
  - `ApiLog.java` - API 日志实体
  - `BaseException.java` - 基础异常类
  - `BusinessException.java` - 业务异常类
  - `Constant.java` - 常量定义
  - `GlobalExceptionHandler.java` - 全局异常处理器
  - `ResponseCodeEnum.java` - 响应码枚举
  - `Result.java` - 统一响应结果封装

### 4. 配置类 (config/)
- **功能**: Spring Boot 配置类，包含各种框架配置
- **主要文件**:
  - `AiConfig.java` - AI 模型配置
  - `ApiLogAspect.java` - API 日志切面配置
  - `JdbcPaginationConfig.java` - JDBC 分页配置
  - `MultipartConfig.java` - 文件上传配置
  - `MybatisPlusConfig.java` - MyBatis-Plus 配置
  - `SecurityConfig.java` - Spring Security 安全配置
  - `TimeZoneConfig.java` - 时区配置
  - `VectorStoreConfig.java` - 向量存储配置
  - `WebConfig.java` - Web 配置
  - `WebLogInterceptor.java` - Web 日志拦截器

### 5. 控制器层 (controller/)
- **功能**: RESTful API 控制器，处理 HTTP 请求
- **主要文件**:
  - `ApiLogController.java` - API 日志控制器
  - `ChatController.java` - 聊天控制器
  - `ChatFeedbackController.java` - 聊天反馈控制器
  - `DashboardController.java` - 仪表板控制器
  - `MockController.java` - 模拟数据控制器
  - `NotificationsController.java` - 通知控制器
  - `PermissionController.java` - 权限控制器
  - `PromptsController.java` - 提示词控制器
  - `RagController.java` - RAG 检索控制器
  - `RagFileController.java` - RAG 文件控制器
  - `RagFileGroupController.java` - RAG 文件组控制器
  - `RoleController.java` - 角色控制器
  - `UserController.java` - 用户控制器

### 6. 安全过滤器 (filter/)
- **功能**: JWT 认证和授权过滤器
- **主要文件**:
  - `JwtAccessDeniedHandler.java` - JWT 访问拒绝处理器
  - `JwtAuthenticationEntryPoint.java` - JWT 认证入口点
  - `JwtAuthenticationFilter.java` - JWT 认证过滤器
  - `JwtLogoutSuccessHandler.java` - JWT 登出成功处理器
  - `LoginFailureHandler.java` - 登录失败处理器
  - `LoginSuccessHandler.java` - 登录成功处理器

### 7. 功能工具 (functionTools/)
- **功能**: 系统功能工具类
- **主要文件**:
  - `DateTimeToolsD.java` - 日期时间工具
  - `FileReadTools.java` - 文件读取工具
  - `RestRequestTools.java` - REST 请求工具

### 8. 数据模型层 (model/)
- **功能**: 数据模型定义，包含实体类、DTO、VO 等

#### 8.1 领域模型 (domain/)
- **功能**: 数据库实体类，对应数据库表结构
- **主要文件**:
  - `TApiLog.java` - API 日志实体
  - `TChatFeedback.java` - 聊天反馈实体
  - `TNotifications.java` - 通知实体
  - `TPermission.java` - 权限实体
  - `TPrompts.java` - 提示词实体
  - `TRagFile.java` - RAG 文件实体
  - `TRagFileGroup.java` - RAG 文件组实体
  - `TRole.java` - 角色实体
  - `TRolePermission.java` - 角色权限关联实体
  - `TTool.java` - 工具实体
  - `TToolGroup.java` - 工具组实体
  - `TUser.java` - 用户实体
  - `TUserChatWindow.java` - 用户聊天窗口实体
  - `TUserRole.java` - 用户角色关联实体
  - `VectorStoreRag.java` - 向量存储 RAG 实体

#### 8.2 数据传输对象 (dto/)
- **功能**: 数据传输对象，用于 API 请求和响应
- **主要文件**:
  - `MyChatRequest.java` - 聊天请求 DTO
  - `UserLoginDTO.java` - 用户登录 DTO

#### 8.3 数据访问层 (mapper/)
- **功能**: MyBatis 数据访问接口
- **主要文件**: 对应每个实体类的 Mapper 接口

#### 8.4 值对象 (vo/)
- **功能**: 视图对象，用于前端展示
- **主要文件**:
  - `ElephantExperimentVo.java` - 大象实验 VO
  - `MyChatResponse.java` - 聊天响应 VO

#### 8.5 普通对象 (pojo/)
- **功能**: 普通 Java 对象
- **主要文件**:
  - `AccountUser.java` - 账户用户对象
  - `ChatModelResult.java` - 聊天模型结果
  - `ChatRestOption.java` - 聊天 REST 选项
  - `GteReRankResult.java` - GTE 重排序结果
  - `RagChangeDocumentsReq.java` - RAG 文档变更请求
  - `RagDeleteDocumentsReq.java` - RAG 文档删除请求
  - `RagMetaData.java` - RAG 元数据
  - `RagWriteDocumentsReq.java` - RAG 文档写入请求

### 9. 业务服务层 (service/)
- **功能**: 业务逻辑处理层
- **主要文件**:
  - `AccountUserDetailsService.java` - 账户用户详情服务
  - `CacheService.java` - 缓存服务
  - `DashboardService.java` - 仪表板服务
  - `NotificationsService.java` - 通知服务
  - `TApiLogService.java` - API 日志服务
  - `TChatFeedbackService.java` - 聊天反馈服务
  - `TNotificationsService.java` - 通知服务
  - `TPermissionService.java` - 权限服务
  - `TPromptsService.java` - 提示词服务
  - `TRagFileGroupService.java` - RAG 文件组服务
  - `TRagFileService.java` - RAG 文件服务
  - `TRolePermissionService.java` - 角色权限服务
  - `TRoleService.java` - 角色服务
  - `TToolGroupService.java` - 工具组服务
  - `TToolService.java` - 工具服务
  - `TUserChatWindowService.java` - 用户聊天窗口服务
  - `TUserRoleService.java` - 用户角色服务
  - `TUserService.java` - 用户服务
  - `VectorStoreService.java` - 向量存储服务

### 10. AI 服务层 (serviceai/)
- **功能**: AI 相关服务，处理聊天、RAG 等功能
- **主要文件**:
  - `ChatService.java` - 聊天服务
  - `ChatGeneralAssistanceService.java` - 通用聊天助手服务
  - `RagService.java` - RAG 检索服务
  - `ReRankModelService.java` - 重排序模型服务
  - `StanfordChatService.java` - Stanford 聊天服务

### 11. 工具类 (utils/)
- **功能**: 各种工具类

#### 11.1 日期工具 (date/)
- `DateTimeUtils.java` - 日期时间工具类

#### 11.2 HTTP 工具 (http/)
- `GetRequestUtils.java` - GET 请求工具
- `PostRequestUtils.java` - POST 请求工具

#### 11.3 其他工具 (other/)
- `EcmaTool.java` - ECMA 工具
- `JwtUtil.java` - JWT 工具类

#### 11.4 分页工具 (pagination/)
- `JdbcPage.java` - JDBC 分页对象
- `JdbcPaginationHelper.java` - JDBC 分页助手
- `README.md` - 分页工具说明文档

#### 11.5 RAG 工具 (rag/)
- `RagFileVectorUtils.java` - RAG 文件向量工具

##### 11.5.1 文本分割器 (rag/splitter/)
- `FixedWindowTextSplitter.java` - 固定窗口文本分割器
- `LlmTextSplitter.java` - LLM 文本分割器
- `PatternTokenTextSplitter.java` - 模式令牌文本分割器
- `SlidingWindowTextSplitter.java` - 滑动窗口文本分割器

#### 11.6 RAG ETL 工具 (rag/RagETL/)
- **Reader/**: 文档读取器
  - `DocumentProcessor.java` - 文档处理器
- **Splitter/**: 文档分割器
- **Writer/**: 文档写入器

### 12. 资源文件 (resources/)

#### 12.1 配置文件
- `application.yml` - 应用主配置文件
- `logback-spring.xml` - 日志配置文件

#### 12.2 MyBatis 映射文件 (mapper/)
- 对应每个实体类的 XML 映射文件

#### 12.3 NLP 模型文件 (nlpModels/)
- `opennlp-en-ud-ewt-sentence-1.2-2.5.0.bin` - OpenNLP 英文句子分割模型 - 未使用

#### 12.4 提示词模板 (prompts/)
- `管理员权限.txt` - 管理员权限提示词

#### 12.5 数据库脚本 (sql/)
- `admin_dml.sql` - 管理员数据脚本
- `api_log_ddl.sql` - API 日志表结构
- `ddl.sql` - 数据库表结构
- `prompt_dml.sql` - 提示词数据脚本
- `从数据库备份文件.md` - 数据库备份说明

#### 12.6 静态资源 (static/)
- `index.html` - 首页文件

## 核心功能模块

### 1. 用户认证与授权
- 基于 JWT 的用户认证
- 角色权限管理
- 用户会话管理

### 2. AI 聊天服务
- 支持多种 AI 模型（OpenAI、Ollama 等）
- 聊天历史记录
- 聊天反馈机制

### 3. RAG 检索增强生成
- 文档向量化存储
- 语义检索
- 文档分割与处理
- 检索结果重排序

### 4. 文件管理
- 文件上传与存储
- 文件分组管理
- 文件向量化处理

### 5. 系统监控
- API 日志记录
- 性能监控
- 用户行为分析

## 部署说明

### 环境要求
- JDK 21+
- PostgreSQL 数据库（需要 pgvector 插件）
- 可选：Ollama（本地 AI 模型）
- 可选：One API（模型管理）

### 配置说明
主要配置文件为 `application.yml`，包含：
- 数据库连接配置
- AI 模型配置
- 向量数据库配置
- 安全配置
- 日志配置

详细部署步骤请参考项目根目录的 `README.md` 文件。 